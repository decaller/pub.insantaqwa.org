<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Editor & Animator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        /* Custom pattern for the transparency background */
        .checkered-bg {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                              linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        /* Ensure SVGs stay within bounds */
        #svg-render-area svg {
            max-width: 100%;
            height: auto;
            max-height: 500px;
        }

        /* Custom scrollbar for editor */
        textarea::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        textarea::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        textarea::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 5px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms, transform 200ms;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen font-sans selection:bg-blue-100">

    <div class="max-w-[1400px] mx-auto px-4 py-6">
        
        <!-- Header -->
        <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-xl font-bold text-slate-900">SVG Editor & Animator</h1>
            </div>
            <div class="flex gap-3">
                <input type="file" id="file-input" accept=".svg" class="hidden">
                <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Upload SVG
                </button>
                <button onclick="resetApp()" class="text-sm text-slate-600 hover:text-red-600 font-medium transition-colors px-4 py-2 border border-slate-200 rounded-lg hover:bg-red-50">
                    Clear / New
                </button>
            </div>
        </div>

        <!-- Error Message (Hidden by default) -->
        <div id="error-msg" class="hidden bg-red-50 text-red-600 px-4 py-3 rounded-lg mb-6 text-center text-sm border border-red-100"></div>

        <!-- Workspace (Always Visible) -->
        <div id="workspace" class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)] min-h-[700px]">
            
            <!-- Left Column: Editors (Span 6) -->
            <div class="lg:col-span-6 flex flex-col gap-4">
                
                <!-- SVG Editor (Top Half) -->
                <div class="flex-1 flex flex-col bg-slate-900 rounded-xl shadow-lg overflow-hidden border border-slate-700 min-h-[250px]">
                    <!-- Editor Toolbar -->
                    <div class="px-4 py-2 bg-slate-800 border-b border-slate-700 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-mono font-bold text-blue-400 uppercase tracking-wider">SVG Source</span>
                            <span id="file-name" class="text-xs text-slate-400 truncate max-w-[150px]">new_file.svg</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="formatCode()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded transition-colors" title="Format XML">Format</button>
                            <button onclick="copyCode('code-editor')" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Text Area -->
                    <textarea id="code-editor" class="flex-1 w-full bg-[#0f172a] text-slate-300 font-mono text-sm p-4 outline-none resize-none leading-relaxed" spellcheck="false" placeholder="<svg>...</svg>"></textarea>
                    <div class="px-4 py-1 bg-slate-800 border-t border-slate-700 text-[10px] text-slate-500 flex justify-between shrink-0">
                        <span id="svg-status-msg">Live updating</span>
                        <span id="file-size">0 KB</span>
                    </div>
                </div>

                <!-- JS Animation Editor (Bottom Half) -->
                <div class="flex-1 flex flex-col bg-slate-900 rounded-xl shadow-lg overflow-hidden border border-slate-700 min-h-[250px]">
                    <!-- JS Toolbar -->
                    <div class="px-4 py-2 bg-slate-800 border-b border-slate-700 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-mono font-bold text-yellow-500 uppercase tracking-wider">Anime.js</span>
                            <button onclick="openImportModal()" class="ml-2 text-[10px] bg-indigo-700 hover:bg-indigo-600 text-white px-2 py-1 rounded transition-colors border border-indigo-500">
                                Import Script
                            </button>
                        </div>
                        <div class="flex gap-1 items-center">
                            <!-- Playback Controls -->
                            <div class="flex bg-slate-700 rounded-lg p-0.5 mr-2">
                                <button onclick="controlAnim('restart')" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 rounded transition-colors" title="Restart |<">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>
                                </button>
                                <button onclick="controlAnim('rewind')" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 rounded transition-colors" title="Rewind -1s">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="22 19 13 12 22 5 22 19"></polygon></svg>
                                </button>
                                
                                <!-- Combined Play/Pause -->
                                <button id="editor-play-btn" onclick="controlAnim('toggle')" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 rounded transition-colors" title="Play/Pause">
                                    <!-- Play Icon (Default) -->
                                    <svg id="icon-play" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                    <!-- Pause Icon (Hidden) -->
                                    <svg id="icon-pause" class="hidden" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                                </button>

                                <button onclick="controlAnim('forward')" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 rounded transition-colors" title="Forward +1s">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>
                                </button>
                                <button onclick="controlAnim('end')" class="p-1.5 text-slate-300 hover:text-white hover:bg-slate-600 rounded transition-colors" title="Skip to End (Before Fade) >|">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
                                </button>
                            </div>

                            <button onclick="runAnimation()" class="text-xs bg-green-700 hover:bg-green-600 text-white px-3 py-1.5 rounded transition-colors flex items-center gap-1 font-semibold border border-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                Update
                            </button>
                        </div>
                    </div>
                    <!-- JS Text Area -->
                    <textarea id="js-editor" class="flex-1 w-full bg-[#0f172a] text-yellow-100 font-mono text-sm p-4 outline-none resize-none leading-relaxed" spellcheck="false" placeholder="// Write Anime.js code here..."></textarea>
                </div>

            </div>

            <!-- Right Column: Preview (Span 6) -->
            <div class="lg:col-span-6 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center shrink-0">
                    <h2 class="font-semibold text-slate-700 text-sm">Preview</h2>
                    <div class="flex items-center gap-2">
                        <label for="bg-toggle" class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Background</label>
                        <select id="bg-toggle" onchange="changeBackground(this.value)" class="text-xs border-slate-200 rounded text-slate-600 bg-white py-1 pl-2 pr-6 focus:ring-blue-500 border outline-none cursor-pointer">
                            <option value="transparent">Transparent</option>
                            <option value="white">White</option>
                            <option value="black">Black</option>
                        </select>
                    </div>
                </div>
                
                <!-- The Visual Render -->
                <div id="preview-container" class="flex-1 p-8 flex justify-center items-center checkered-bg overflow-auto relative">
                    <div id="svg-render-area" class="transition-all duration-200">
                        <!-- SVG injects here -->
                    </div>
                </div>
                 <div class="px-4 py-3 bg-slate-50 border-t border-slate-100 text-center shrink-0">
                    <button onclick="downloadExport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Download HTML (SVG + Anim)
                    </button>
                    <p class="text-[10px] text-slate-400 mt-2">Exports a standalone HTML file with embedded SVG, controls, and theme support.</p>
                </div>
            </div>

        </div>

    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden modal-enter-active">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Import Animation Script</h3>
                <button onclick="closeImportModal()" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-2">Paste your commands below. Supported commands:</p>
                <ul class="text-xs text-slate-500 font-mono mb-4 bg-slate-50 p-2 rounded border border-slate-200">
                    <li>show [element_id]</li>
                    <li>show [element_id] fade</li>
                    <li>wait [milliseconds]</li>
                </ul>
                <textarea id="script-input" class="w-full h-48 bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-700" placeholder="show e_8-fYTNvDUIlX3444rX-3 fade&#10;wait 1000&#10;show e_8-fYTNvDUIlX3444rX-17"></textarea>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeImportModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">Cancel</button>
                <button onclick="convertAndImport()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm">Convert & Import</button>
            </div>
        </div>
    </div>

    <script>
        // Monkey patch anime to track instances for cleanup
        const originalAnime = window.anime;
        let activeAnimations = [];

        window.anime = function(params) {
            const instance = originalAnime(params);
            activeAnimations.push(instance);
            return instance;
        }
        // Copy static properties like anime.setDashoffset
        Object.assign(window.anime, originalAnime);

        const fileInput = document.getElementById('file-input');
        const workspace = document.getElementById('workspace');
        const svgRenderArea = document.getElementById('svg-render-area');
        const previewContainer = document.getElementById('preview-container');
        const codeEditor = document.getElementById('code-editor');
        const jsEditor = document.getElementById('js-editor');
        const fileNameEl = document.getElementById('file-name');
        const fileSizeEl = document.getElementById('file-size');
        const errorMsg = document.getElementById('error-msg');
        const svgStatusMsg = document.getElementById('svg-status-msg');
        const importModal = document.getElementById('import-modal');
        const scriptInput = document.getElementById('script-input');

        // Default SVG Template
        const defaultSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
  <rect id="box" x="50" y="50" width="100" height="100" fill="#3b82f6" rx="10"/>
  <circle id="circle" cx="100" cy="100" r="30" fill="#fbbf24"/>
</svg>`;

        // Default Animation Template
        const defaultJs = `// Simple rotation example
anime({
  targets: '#box',
  rotate: 360,
  duration: 3000,
  loop: true,
  easing: 'easeInOutSine'
});

anime({
  targets: '#circle',
  scale: [0.8, 1.2],
  duration: 1500,
  loop: true,
  direction: 'alternate',
  easing: 'easeInOutQuad'
});`;

        // --- Init ---
        // Load default content on startup
        window.addEventListener('DOMContentLoaded', () => {
            codeEditor.value = defaultSvg;
            jsEditor.value = defaultJs;
            svgRenderArea.innerHTML = defaultSvg;
            fileSizeEl.textContent = formatBytes(new Blob([defaultSvg]).size);
        });

        // --- File Input ---
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // --- Live SVG Preview ---
        codeEditor.addEventListener('input', () => {
            const content = codeEditor.value;
            svgStatusMsg.textContent = "Editing...";
            try {
                if (content.trim() === "") {
                    svgRenderArea.innerHTML = "";
                } else {
                    stopAnimation();
                    svgRenderArea.innerHTML = content;
                }
                svgStatusMsg.textContent = "Preview updated";
            } catch (e) {
                svgStatusMsg.textContent = "Error parsing SVG";
            }
            fileSizeEl.textContent = formatBytes(new Blob([content]).size);
        });

        function handleFile(file) {
            errorMsg.classList.add('hidden');
            if (file.type !== 'image/svg+xml' && !file.name.endsWith('.svg')) {
                showError('Please upload a valid SVG file.');
                return;
            }
            fileNameEl.textContent = file.name;
            fileSizeEl.textContent = formatBytes(file.size);

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                if (!content.includes('<svg')) {
                    showError('The file does not appear to be valid SVG code.');
                    return;
                }
                loadContent(content);
            };
            reader.onerror = () => showError('Error reading file.');
            reader.readAsText(file);
        }

        function loadContent(content) {
            codeEditor.value = content;
            svgRenderArea.innerHTML = content;
            
            // Format code nicely
            formatCode();
        }

        // --- Background Toggle ---
        function changeBackground(type) {
            // Remove all bg classes first
            previewContainer.classList.remove('checkered-bg', 'bg-white', 'bg-black');
            
            if (type === 'transparent') {
                previewContainer.classList.add('checkered-bg');
            } else if (type === 'white') {
                previewContainer.classList.add('bg-white');
            } else if (type === 'black') {
                previewContainer.classList.add('bg-black');
            }
        }

        // --- Animation Logic ---

        function runAnimation() {
            stopAnimation();
            svgRenderArea.innerHTML = codeEditor.value;
            const code = jsEditor.value;
            try {
                const runUserCode = new Function(code);
                runUserCode();
            } catch (err) {
                alert("JS Error: " + err.message);
            }
            // Ensure play button state is correct (Play icon if paused, Pause if running)
             updatePlayButton(true);
        }

        function stopAnimation() {
            activeAnimations.forEach(anim => anim.pause());
            activeAnimations = [];
            if (codeEditor.value) {
                svgRenderArea.innerHTML = codeEditor.value;
            }
            updatePlayButton(false);
        }

        // Toggle UI Helper
        function updatePlayButton(isPlaying) {
            const iconPlay = document.getElementById('icon-play');
            const iconPause = document.getElementById('icon-pause');
            if (isPlaying) {
                iconPlay.classList.add('hidden');
                iconPause.classList.remove('hidden');
            } else {
                iconPlay.classList.remove('hidden');
                iconPause.classList.add('hidden');
            }
        }

        // New Control Logic
        function controlAnim(action) {
            if (activeAnimations.length === 0 && action !== 'toggle') {
                // If nothing active, try running first
                runAnimation();
                if(action === 'toggle') return; // Handled by runAnimation
            }

            activeAnimations.forEach(anim => {
                if (action === 'restart') {
                    anim.restart();
                    updatePlayButton(true);
                }
                if (action === 'toggle') {
                    if (anim.paused) {
                        anim.play();
                        updatePlayButton(true);
                    } else {
                        anim.pause();
                        updatePlayButton(false);
                    }
                }
                if (action === 'rewind') anim.seek(Math.max(0, anim.currentTime - 1000));
                if (action === 'forward') anim.seek(Math.min(anim.duration, anim.currentTime + 1000));
                
                if (action === 'end') {
                    anim.pause();
                    // Go to duration - 1s (fade time) - 100ms (buffer)
                    // If fading is 1s, we want to be right before that start.
                    // The duration of timeline includes the fade. 
                    // Let's assume the fade is the last 1000ms.
                    let targetTime = Math.max(0, anim.duration - 1000 - 100); 
                    anim.seek(targetTime);
                    updatePlayButton(false);
                }
            });
            
            // Special case for toggle if no animation exists
            if (activeAnimations.length === 0 && action === 'toggle') {
                runAnimation();
            }
        }

        // --- Import Logic ---

        function openImportModal() {
            importModal.classList.remove('hidden');
            scriptInput.focus();
        }

        function closeImportModal() {
            importModal.classList.add('hidden');
        }

        function convertAndImport() {
            const input = scriptInput.value;
            if(!input.trim()) return;

            const lines = input.split('\n').map(l => l.trim()).filter(l => l);
            const targets = new Set();
            const steps = [];
            let currentOffset = 0;

            lines.forEach(line => {
                const parts = line.split(/\s+/);
                const command = parts[0].toLowerCase();

                if (command === 'wait') {
                    const ms = parseInt(parts[1], 10);
                    if (!isNaN(ms)) {
                        currentOffset += ms;
                    }
                } else if (command === 'show') {
                    const id = parts[1];
                    const isFade = parts.includes('fade');
                    if (id) {
                        // Use a selector that targets either ID or data-cell-id
                        const selectorStr = `#${id}, [data-cell-id="${id}"]`;
                        const jsSelector = `'#${id}, [data-cell-id="${id}"]'`;
                        targets.add(jsSelector);
                        
                        // --- Direction Detection Logic ---
                        let clipPathConfig = "['inset(0% 100% 0% 0%)', 'inset(0% 0% 0% 0%)']"; // Default L->R
                        
                        try {
                            // Find the element in the preview area to analyze it
                            let el = document.querySelector(selectorStr);
                            
                            // If the element is a Group <g>, try to find the first <path> inside it
                            if (el && el.tagName.toLowerCase() === 'g') {
                                const internalPath = el.querySelector('path');
                                if (internalPath) {
                                    el = internalPath;
                                }
                            }

                            if (el && el.tagName.toLowerCase() === 'path') {
                                try {
                                    const len = el.getTotalLength();
                                    const p0 = el.getPointAtLength(0);
                                    const p1 = el.getPointAtLength(len);
                                    const dx = p1.x - p0.x;
                                    const dy = p1.y - p0.y;

                                    if (Math.abs(dx) > Math.abs(dy)) {
                                        // Horizontal Movement
                                        if (dx > 0) {
                                            // Left to Right (Default)
                                            clipPathConfig = "['inset(0% 100% 0% 0%)', 'inset(0% 0% 0% 0%)']";
                                        } else {
                                            // Right to Left
                                            clipPathConfig = "['inset(0% 0% 0% 100%)', 'inset(0% 0% 0% 0%)']";
                                        }
                                    } else {
                                        // Vertical Movement
                                        if (dy > 0) {
                                            // Down (Top to Bottom reveal)
                                            clipPathConfig = "['inset(0% 0% 100% 0%)', 'inset(0% 0% 0% 0%)']";
                                        } else {
                                            // Up (Bottom to Top reveal)
                                            clipPathConfig = "['inset(100% 0% 0% 0%)', 'inset(0% 0% 0% 0%)']";
                                        }
                                    }
                                } catch(e) {
                                    console.log("Could not measure path, using default L->R");
                                }
                            }
                        } catch(e) {
                            console.log("Could not find element to analyze, using default L->R");
                        }
                        // ---------------------------------

                        steps.push({
                            target: jsSelector,
                            isFade: isFade,
                            offset: currentOffset,
                            clipPath: clipPathConfig
                        });
                        currentOffset = 0; 
                    }
                }
            });

            if (steps.length === 0) {
                alert("No valid 'show' commands found.");
                return;
            }

            // Generate Code
            let code = `// --- Generated Animation ---\n\n`;
            code += `// 1. Initial State: Hide all participating elements\n`;
            code += `anime.set([${Array.from(targets).join(', ')}], { opacity: 0 });\n\n`;
            code += `// 2. Create Timeline\n`;
            code += `var tl = anime.timeline({\n  easing: 'easeOutQuad',\n  autoplay: true,\n  loop: true // Loop entire sequence\n});\n\n`;
            code += `// 3. Add Steps\n`;
            code += `tl\n`;

            steps.forEach((step, index) => {
                const duration = 1000; 
                const offsetStr = step.offset > 0 ? `'+=${step.offset}'` : `'-=0'`;
                
                code += `.add({\n`;
                code += `  targets: ${step.target},\n`;
                
                if (step.isFade) {
                    code += `  opacity: [0, 1],\n`;
                    code += `  easing: 'linear',\n`;
                } else {
                    // Wipe Effect (Directional)
                    code += `  opacity: 1,\n`; 
                    code += `  clipPath: ${step.clipPath},\n`;
                    code += `  easing: 'easeInOutQuad',\n`;
                }
                
                code += `  duration: ${duration}\n`;
                code += `}, ${offsetStr})`;
                
                code += `\n`; // New line for next step
            });

            // --- END SEQUENCE: Wait 4s, Fade Out, Loop ---
            code += `// 4. End Loop: Wait 4s, then fade everything out\n`;
            code += `.add({\n`;
            code += `  targets: [${Array.from(targets).join(', ')}],\n`;
            code += `  opacity: 0,\n`;
            code += `  duration: 1000,\n`;
            code += `  easing: 'linear'\n`;
            code += `}, '+=4000'); // Wait 4000ms after last step`;

            code += `;`;

            jsEditor.value = code;
            closeImportModal();
            alert("Script imported! Click 'Update' or Play to view.");
        }

        // --- Utilities ---

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
        }

        function resetApp() {
            stopAnimation();
            fileInput.value = '';
            // Reset to defaults
            codeEditor.value = defaultSvg;
            jsEditor.value = defaultJs;
            svgRenderArea.innerHTML = defaultSvg;
            fileNameEl.textContent = "new_file.svg";
            fileSizeEl.textContent = formatBytes(new Blob([defaultSvg]).size);
            
            errorMsg.classList.add('hidden');
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function copyCode(elementId) {
            const el = document.getElementById(elementId);
            navigator.clipboard.writeText(el.value);
        }

        function downloadExport() {
            const svgContent = codeEditor.value;
            const jsContent = jsEditor.value;
            
            // Create a standalone HTML template with Controls & Theme support
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animated SVG</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"><\/script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #1e293b;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --border-color: #e2e8f0;
            --icon-color: #64748b;
            --icon-hover: #0f172a;
        }
        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-color: #f8fafc;
            --panel-bg: rgba(30, 41, 59, 0.9);
            --border-color: #334155;
            --icon-color: #94a3b8;
            --icon-hover: #ffffff;
        }
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }
        /* No extra container, just SVG */
        svg {
            max-width: 95vw;
            max-height: 95vh;
            width: auto;
            height: auto;
        }

        /* Controls */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 99px;
            display: flex;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            z-index: 100;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--icon-color);
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            color: var(--icon-hover);
            background-color: rgba(128,128,128, 0.1);
        }
        .hidden { display: none; }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel-bg);
            backdrop-filter: blur(8px);
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            cursor: pointer;
            color: var(--icon-color);
            z-index: 100;
        }
        .theme-toggle:hover {
            color: var(--icon-hover);
        }
    </style>
</head>
<body>

    ${svgContent}

    <!-- Controls UI -->
    <div class="controls">
        <button class="btn" id="btn-restart" title="Restart">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>
        </button>
        <button class="btn" id="btn-rewind" title="Rewind">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="22 19 13 12 22 5 22 19"></polygon></svg>
        </button>
        <button class="btn" id="btn-toggle" title="Play/Pause">
             <!-- Play Icon -->
            <svg id="icon-play" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <!-- Pause Icon -->
            <svg id="icon-pause" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        </button>
        <button class="btn" id="btn-forward" title="Forward">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>
        </button>
         <button class="btn" id="btn-end" title="Skip to End (Before Fade)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
        </button>
    </div>

    <!-- Theme Toggle -->
    <button class="theme-toggle" id="btn-theme" title="Toggle Theme">
        <!-- Sun Icon -->
        <svg id="icon-sun" style="display:none;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <!-- Moon Icon -->
        <svg id="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. User Animation Code
            ${jsContent}

            // 2. Control Logic
            const btnRestart = document.getElementById('btn-restart');
            const btnRewind = document.getElementById('btn-rewind');
            const btnToggle = document.getElementById('btn-toggle');
            const btnForward = document.getElementById('btn-forward');
            const btnEnd = document.getElementById('btn-end');
            
            const iconPlay = document.getElementById('icon-play');
            const iconPause = document.getElementById('icon-pause');

            function updatePlayBtn(isPlaying) {
                 if (isPlaying) {
                    iconPlay.classList.add('hidden');
                    iconPause.classList.remove('hidden');
                } else {
                    iconPlay.classList.remove('hidden');
                    iconPause.classList.add('hidden');
                }
            }

            // Assuming 'tl' is defined in the user code above
            if (typeof tl !== 'undefined') {
                updatePlayBtn(true); // Auto-plays by default

                btnRestart.onclick = () => { tl.restart(); updatePlayBtn(true); };
                btnRewind.onclick = () => tl.seek(Math.max(0, tl.currentTime - 1000));
                
                btnToggle.onclick = () => {
                    if (tl.paused) {
                        tl.play();
                        updatePlayBtn(true);
                    } else {
                        tl.pause();
                        updatePlayBtn(false);
                    }
                };

                btnForward.onclick = () => tl.seek(Math.min(tl.duration, tl.currentTime + 1000));
                
                btnEnd.onclick = () => {
                    tl.pause();
                    let targetTime = Math.max(0, tl.duration - 1000 - 100); 
                    tl.seek(targetTime);
                    updatePlayBtn(false);
                };
            }

            // 3. Theme Logic
            const btnTheme = document.getElementById('btn-theme');
            const iconSun = document.getElementById('icon-sun');
            const iconMoon = document.getElementById('icon-moon');
            
            function setTheme(isDark) {
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    iconSun.style.display = 'block';
                    iconMoon.style.display = 'none';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    iconSun.style.display = 'none';
                    iconMoon.style.display = 'block';
                }
            }

            // Auto-detect
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            let isDark = darkModeMediaQuery.matches;
            setTheme(isDark);

            // Toggle
            btnTheme.onclick = () => {
                isDark = !isDark;
                setTheme(isDark);
            };
            
            // Listen for system changes
            darkModeMediaQuery.addEventListener('change', (e) => {
                isDark = e.matches;
                setTheme(isDark);
            });
        });
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            let name = fileNameEl.textContent || 'animation';
            name = name.replace('.svg', '');
            a.download = `${name}-animated.html`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatCode() {
            let xml = codeEditor.value;
            let formatted = '';
            let reg = /(>)(<)(\/*)/g;
            xml = xml.replace(reg, '$1\r\n$2$3');
            let pad = 0;
            const lines = xml.split('\r\n');
            lines.forEach(line => {
                let indent = 0;
                if (line.match(/.+<\/\w[^>]*>$/)) indent = 0;
                else if (line.match(/^<\/\w/)) { if (pad !== 0) pad -= 1; }
                else if (line.match(/^<\w[^>]*[^\/]>.*$/)) indent = 1;
                else indent = 0;
                
                let padding = '';
                for (let i = 0; i < pad; i++) padding += '  ';
                formatted += padding + line + '\r\n';
                pad += indent;
            });
            codeEditor.value = formatted.trim();
            codeEditor.dispatchEvent(new Event('input'));
        }
    </script>
</body>
</html>
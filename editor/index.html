<!doctype html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Brainless HTML Editor</title>

        <!-- DaisyUI and Tailwind CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
            rel="stylesheet"
            type="text/css"
        />
        <script src="https://cdn.tailwindcss.com"></script>

        <!-- Icons -->
        <script src="https://unpkg.com/lucide@latest"></script>

        <!-- CodeMirror (Editor) -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

        <!-- JS Beautify (Prettier) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>

        <style>
            /* Editor Customization */
            .CodeMirror {
                height: 100%;
                font-family: "Fira Code", "Menlo", monospace;
                font-size: 13px;
                border-radius: 0.5rem;
            }

            /* Loading overlay */
            .loader-overlay {
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
            }
        </style>
    </head>
    <body class="h-screen flex flex-col overflow-hidden bg-base-300">
        <!-- Main Content -->
        <div class="flex flex-1 h-screen overflow-hidden">
            <!-- LEFT PANEL: Controls (40% width) -->
            <div
                class="w-2/5 min-w-[400px] bg-base-200 flex flex-col border-r border-base-300 shadow-xl z-10"
            >
                <!-- TOP: Full Source Input -->
                <div class="flex flex-col h-1/3 p-4 pb-2">
                    <label class="label pt-0 pb-2">
                        <span
                            class="label-text font-bold flex items-center gap-2"
                        >
                            <i data-lucide="file-code" class="w-4 h-4"></i> Full
                            Source Code
                        </span>
                        <span class="badge badge-xs badge-neutral">HTML</span>
                    </label>
                    <div
                        class="flex-1 border border-base-content/20 rounded-lg overflow-hidden relative"
                    >
                        <textarea id="sourceEditor"></textarea>
                    </div>
                    <button
                        onclick="loadFromSource()"
                        class="btn btn-primary btn-sm w-full mt-2"
                    >
                        <i data-lucide="play"></i> Render & Load
                    </button>
                </div>

                <div class="divider my-0 px-4"></div>

                <!-- MIDDLE: Tools -->
                <div class="px-4 py-2">
                    <div
                        class="flex items-center justify-between bg-base-100 p-3 rounded-box shadow-sm border border-base-content/10"
                    >
                        <div>
                            <h3 class="font-bold text-sm">Inspector Mode</h3>
                            <p class="text-xs text-base-content/60">
                                Select elements to edit below
                            </p>
                        </div>
                        <button
                            id="inspectBtn"
                            onclick="toggleInspector()"
                            class="btn btn-circle btn-outline btn-sm"
                        >
                            <i
                                data-lucide="mouse-pointer-2"
                                class="w-4 h-4"
                            ></i>
                        </button>
                    </div>
                </div>

                <!-- BOTTOM: Selected Element Editor -->
                <div class="flex-1 flex flex-col min-h-0 p-4 pt-2">
                    <label class="label pt-0 pb-2">
                        <span
                            class="label-text font-bold flex items-center gap-2"
                        >
                            <i data-lucide="pencil" class="w-4 h-4"></i> Live
                            Element Editor
                        </span>
                        <span
                            id="tagBadge"
                            class="badge badge-secondary badge-outline text-xs hidden"
                            >div</span
                        >
                    </label>
                    <div
                        class="relative flex-1 border border-base-content/20 rounded-lg overflow-hidden shadow-inner"
                    >
                        <textarea id="elementEditor"></textarea>
                        <!-- Formatting indicator -->
                        <div
                            class="absolute bottom-2 right-2 z-20 opacity-50 hover:opacity-100 transition-opacity"
                        >
                            <span class="badge badge-ghost badge-xs"
                                >Auto-Prettier On</span
                            >
                        </div>
                    </div>
                    <div
                        class="text-xs text-base-content/50 mt-2 flex justify-between"
                    >
                        <span>Edits apply automatically</span>
                        <div class="flex gap-2">
                            <button
                                onclick="downloadHtml()"
                                class="link link-hover text-success text-xs flex items-center gap-1"
                            >
                                <i data-lucide="download" class="w-3 h-3"></i>
                                Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: Preview (60% width) -->
            <div class="flex-1 bg-white relative shadow-inner">
                <!-- Overlay for Inspector Mode (visual cue) -->
                <div
                    id="inspectorOverlay"
                    class="absolute top-4 left-1/2 -translate-x-1/2 bg-accent text-accent-content px-4 py-2 rounded-full shadow-lg z-40 hidden font-bold animate-bounce pointer-events-none flex items-center gap-2"
                >
                    <i data-lucide="scan-search" class="w-4 h-4"></i>
                    Inspecting...
                </div>

                <iframe
                    id="previewFrame"
                    class="w-full h-full border-none"
                    sandbox="allow-same-origin allow-scripts allow-modals"
                ></iframe>
            </div>
        </div>

        <!-- Javascript Logic -->
        <script>
            // Icons
            lucide.createIcons();

            // --- Configuration & State ---
            let isInspecting = false;
            let currentSelectedElement = null;
            let cmSource = null;
            let cmElement = null;

            const frame = document.getElementById("previewFrame");
            const inspectBtn = document.getElementById("inspectBtn");
            const overlay = document.getElementById("inspectorOverlay");

            const defaultTemplate = `<!DOCTYPE html>
<html>
<head>
<style>
    body { font-family: 'Segoe UI', sans-serif; padding: 2rem; color: #333; background: #f9f9f9; }
    h1 { color: #570df8; }
    .card {
        background: white;
        border: 1px solid #eee;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        max-width: 400px;
        transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-2px); }
    button {
        background: #570df8;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
    }
    button:hover { background: #4506cb; }
</style>
</head>
<body>
    <h1>DOM Editor</h1>
    <p class="subtitle">Select elements on the right to edit them live!</p>

    <div class="card">
        <h2>Editable Component</h2>
        <p>This is a sample card. Use the inspector button to click me and edit my source code.</p>
        <button onclick="alert('Hello!')">Interact</button>
    </div>
</body>
</html>`;

            // --- Initialization ---
            window.addEventListener("DOMContentLoaded", () => {
                initEditors();

                // Set default content in source editor
                cmSource.setValue(defaultTemplate);

                // Render it
                loadFromSource();
            });

            function initEditors() {
                // Source Editor (Top)
                cmSource = CodeMirror.fromTextArea(
                    document.getElementById("sourceEditor"),
                    {
                        mode: "htmlmixed",
                        theme: "dracula",
                        lineNumbers: true,
                        lineWrapping: true,
                        tabSize: 2,
                    },
                );

                // Element Editor (Bottom)
                cmElement = CodeMirror.fromTextArea(
                    document.getElementById("elementEditor"),
                    {
                        mode: "htmlmixed",
                        theme: "dracula",
                        lineNumbers: true,
                        lineWrapping: true,
                        tabSize: 2,
                        autoCloseBrackets: true,
                        matchBrackets: true,
                    },
                );

                // Listen for changes in the element editor
                cmElement.on("change", (instance, changeObj) => {
                    if (changeObj.origin === "setValue") return; // Don't trigger on program update
                    applyElementChange(instance.getValue());
                });
            }

            // --- Core Functions ---

            function loadFromSource() {
                const content = cmSource.getValue();
                if (!content.trim()) return;

                // Stop inspection if active
                if (isInspecting) toggleInspector();

                currentSelectedElement = null;
                cmElement.setValue("<!-- Select an element to edit -->");

                writeToFrame(content);
            }

            function writeToFrame(html) {
                const doc =
                    frame.contentDocument || frame.contentWindow.document;
                doc.open();
                doc.write(html);
                doc.close();

                injectInspectorStyles(doc);
            }

            function injectInspectorStyles(doc) {
                const style = doc.createElement("style");
                style.id = "inspector-styles";
                style.textContent = `
                .inspector-hover {
                    outline: 2px solid #ff00d4 !important;
                    background-color: rgba(255, 0, 212, 0.1) !important;
                    cursor: crosshair !important;
                    box-shadow: 0 0 10px rgba(255,0,212,0.3);
                }
                .inspector-selected {
                    outline: 2px dashed #570df8 !important;
                    background-color: rgba(87, 13, 248, 0.05) !important;
                    animation: pulse-border 2s infinite;
                }
                @keyframes pulse-border {
                    0% { outline-color: #570df8; }
                    50% { outline-color: #a76bf8; }
                    100% { outline-color: #570df8; }
                }
            `;
                doc.head.appendChild(style);
            }

            // --- Inspector Logic ---

            function toggleInspector() {
                isInspecting = !isInspecting;
                const doc =
                    frame.contentDocument || frame.contentWindow.document;

                if (isInspecting) {
                    inspectBtn.classList.replace("btn-outline", "btn-accent");
                    overlay.classList.remove("hidden");

                    doc.body.addEventListener("mouseover", handleHover);
                    doc.body.addEventListener("mouseout", handleHoverOut);
                    doc.body.addEventListener("click", handleClick);
                } else {
                    inspectBtn.classList.replace("btn-accent", "btn-outline");
                    overlay.classList.add("hidden");

                    doc.body.removeEventListener("mouseover", handleHover);
                    doc.body.removeEventListener("mouseout", handleHoverOut);
                    doc.body.removeEventListener("click", handleClick);

                    // Cleanup hover visual
                    const hovered = doc.querySelector(".inspector-hover");
                    if (hovered) hovered.classList.remove("inspector-hover");
                }
            }

            function handleHover(e) {
                e.stopPropagation();
                e.target.classList.add("inspector-hover");
            }

            function handleHoverOut(e) {
                e.stopPropagation();
                e.target.classList.remove("inspector-hover");
            }

            function handleClick(e) {
                e.preventDefault();
                e.stopPropagation();

                // Handle Selection
                const doc = frame.contentDocument;
                const prev = doc.querySelector(".inspector-selected");
                if (prev) prev.classList.remove("inspector-selected");

                const target = e.target;
                target.classList.remove("inspector-hover");
                target.classList.add("inspector-selected");

                currentSelectedElement = target;

                // UI Updates
                const badge = document.getElementById("tagBadge");
                badge.textContent =
                    target.tagName.toLowerCase() +
                    (target.id ? "#" + target.id : "") +
                    (target.className
                        ? "." + target.className.split(" ")[0]
                        : "");
                badge.classList.remove("hidden");

                // Get Code and Beautify
                const rawHtml = target.outerHTML;
                // Clean inspector classes before displaying
                const cleanHtml = rawHtml
                    .replace(/inspector-selected|inspector-hover/g, "")
                    .replace(/class="\s*"/, "");

                const formattedHtml = html_beautify(cleanHtml, {
                    indent_size: 2,
                    wrap_line_length: 80,
                    preserve_newlines: false,
                });

                cmElement.setValue(formattedHtml);
            }

            // --- Live Editing Logic ---

            function applyElementChange(newHtml) {
                if (!currentSelectedElement) return;

                const doc =
                    frame.contentDocument || frame.contentWindow.document;

                try {
                    // Create a temporary container to parse the new HTML
                    const tempContainer = doc.createElement("div");
                    tempContainer.innerHTML = newHtml;

                    const newElement = tempContainer.firstElementChild;

                    if (newElement) {
                        // Re-apply inspector class to maintain context
                        newElement.classList.add("inspector-selected");

                        // Replace in DOM
                        currentSelectedElement.replaceWith(newElement);

                        // Update Reference
                        currentSelectedElement = newElement;
                    }
                } catch (err) {
                    // Silent catch for partial HTML during typing
                }
            }

            // --- Download ---

            function downloadHtml() {
                const doc = frame.contentDocument;

                // Cleanup
                const cloneDoc = doc.cloneNode(true);
                const inspectorStyle =
                    cloneDoc.getElementById("inspector-styles");
                if (inspectorStyle) inspectorStyle.remove();

                const selected = cloneDoc.querySelectorAll(
                    ".inspector-selected, .inspector-hover",
                );
                selected.forEach((el) => {
                    el.classList.remove("inspector-selected");
                    el.classList.remove("inspector-hover");
                });

                const content = cloneDoc.documentElement.outerHTML;
                const formattedContent = html_beautify(content, {
                    indent_size: 2,
                });

                const blob = new Blob([formattedContent], {
                    type: "text/html",
                });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "edited-page.html";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        </script>
    </body>
</html>
